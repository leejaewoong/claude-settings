"""
Celery tasks for crawling
"""
import asyncio
import logging
from typing import Dict, Any

from app.celery_app import celery_app
from app.services.naver_cafe_crawler import NaverCafeCrawler
from app.services.post_service import save_posts

logger = logging.getLogger(__name__)


@celery_app.task(name="app.tasks.crawler_tasks.crawl_and_save_naver_cafe", bind=True)
def crawl_and_save_naver_cafe(self) -> Dict[str, Any]:
    """
    Celery task to crawl Naver Cafe and save to database.
    Runs every 3 hours as configured in beat_schedule.

    Returns:
        Dictionary with crawl results and statistics
    """
    logger.info("Starting scheduled Naver Cafe crawl task")

    try:
        # Run async crawler in sync context
        result = asyncio.run(_async_crawl_and_save())
        logger.info(f"Crawl task completed: {result}")
        return result
    except Exception as e:
        logger.error(f"Crawl task failed: {str(e)}", exc_info=True)
        # Retry with exponential backoff: 5 min, 10 min, 20 min
        raise self.retry(exc=e, countdown=5 * 60, max_retries=3)


async def _async_crawl_and_save() -> Dict[str, Any]:
    """
    Async function to perform crawling and saving.

    Returns:
        Dictionary with crawl statistics
    """
    crawler = NaverCafeCrawler()

    # Crawl all menus
    logger.info("Starting crawl of all menus")
    all_results = await crawler.crawl_all_menus()

    # Flatten results
    all_posts = []
    menu_stats = {}

    for menu_id, posts in all_results.items():
        all_posts.extend(posts)
        menu_stats[f"menu_{menu_id}"] = len(posts)

    logger.info(f"Crawled {len(all_posts)} total posts from {len(all_results)} menus")

    # Save to database
    if all_posts:
        save_result = await save_posts(all_posts)
        logger.info(f"Save results: {save_result}")
    else:
        save_result = {"inserted": 0, "updated": 0, "failed": 0}
        logger.warning("No posts to save")

    return {
        "total_posts": len(all_posts),
        "menus_crawled": len(all_results),
        "menu_stats": menu_stats,
        "save_result": save_result,
    }


@celery_app.task(name="app.tasks.crawler_tasks.test_task")
def test_task() -> str:
    """Simple test task to verify Celery is working"""
    logger.info("Test task executed")
    return "Test task completed successfully"
