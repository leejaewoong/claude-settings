"""
Debug crawler to see what's actually loaded
"""
import asyncio
import sys
import os

sys.path.insert(0, os.path.join(os.path.dirname(__file__), "."))

from playwright.async_api import async_playwright


async def main():
    print("=== Debug Crawler ===\n")

    # Test URL
    test_url = "https://cafe.naver.com/f-e/cafes/28866679/menus/1?viewType=L"

    async with async_playwright() as p:
        browser = await p.chromium.launch(headless=False)  # Show browser
        context = await browser.new_context(
            user_agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
            viewport={"width": 1920, "height": 1080}
        )
        page = await context.new_page()

        print(f"Loading: {test_url}")
        await page.goto(test_url, wait_until="networkidle")

        # Take screenshot of list page
        await page.screenshot(path="screenshot_list.png")
        print("Screenshot saved: screenshot_list.png")

        # Get page HTML
        html = await page.content()
        with open("page_list.html", "w", encoding="utf-8") as f:
            f.write(html)
        print("HTML saved: page_list.html")

        # Wait a bit for user to see
        print("\nBrowser will stay open for 10 seconds...")
        await asyncio.sleep(10)

        # Now try to get a post
        print("\nClicking first article...")
        try:
            first_article = await page.query_selector("a.article")
            if first_article:
                await first_article.click()
                await asyncio.sleep(3)

                # Take screenshot of detail page
                await page.screenshot(path="screenshot_detail.png")
                print("Screenshot saved: screenshot_detail.png")

                # Get detail HTML
                html = await page.content()
                with open("page_detail.html", "w", encoding="utf-8") as f:
                    f.write(html)
                print("HTML saved: page_detail.html")

                # Check what elements exist
                print("\nChecking for content elements...")
                selectors_to_check = [
                    ".article_container",
                    ".article_viewer",
                    ".ArticleContentBox",
                    ".se-main-container",
                    "#app-body",
                    ".ContentRenderer"
                ]

                for selector in selectors_to_check:
                    el = await page.query_selector(selector)
                    if el:
                        text = await el.inner_text()
                        print(f"✓ Found {selector}: {len(text)} chars")
                    else:
                        print(f"✗ Not found: {selector}")

                print("\nBrowser will stay open for 10 seconds...")
                await asyncio.sleep(10)
        except Exception as e:
            print(f"Error: {e}")

        await browser.close()

    print("\n=== Debug Complete! ===")
    print("Check screenshot_list.png, screenshot_detail.png, page_list.html, page_detail.html")


if __name__ == "__main__":
    asyncio.run(main())
