"""
Test script to verify crawling and DB saving functionality
"""
import asyncio
import sys
import os

# Add the app directory to the path
sys.path.insert(0, os.path.join(os.path.dirname(__file__), "."))

from app.services.naver_cafe_crawler import NaverCafeCrawler
from app.services.post_service import save_posts, get_recent_posts


async def main():
    print("=== Testing Crawler and DB Save ===\n")

    # Step 1: Crawl
    print("Step 1: Crawling menu 1...")
    crawler = NaverCafeCrawler()
    results = await crawler.crawl_menu(1)

    print(f"Crawled {len(results)} posts\n")

    if results:
        # Show first result
        first_post = results[0]
        print(f"First post example:")
        print(f"  - Title: {first_post['title'][:50]}...")
        print(f"  - External ID: {first_post['external_id']}")
        print(f"  - Author: {first_post['author']}")
        print(f"  - Content length: {len(first_post['content'])} chars")
        print(f"  - Comments: {len(first_post['comments'])} comments")
        print(f"  - URL: {first_post['url']}\n")

    # Step 2: Save to DB
    print("Step 2: Saving to database...")
    save_result = await save_posts(results)
    print(f"Save result: {save_result}\n")

    # Step 3: Verify from DB
    print("Step 3: Retrieving from database...")
    posts = await get_recent_posts(limit=5)
    print(f"Retrieved {len(posts)} posts from DB")

    if posts:
        for i, post in enumerate(posts, 1):
            print(f"\n{i}. {post.title[:50]}")
            print(f"   External ID: {post.external_id}")
            print(f"   Author: {post.author}")
            print(f"   Comments: {len(post.comments)} comments")
            print(f"   Collected at: {post.collected_at}")

    print("\n=== Test Complete! ===")


if __name__ == "__main__":
    asyncio.run(main())
